{
    "AWSTemplateFormatVersion" : "2010-09-09",
    "Description": "Creates resources for Activity Log backend components.",
	"Parameters" : {
		"Environment" : {
			"Type" : "String",
			"AllowedValues" : ["test", "prod"]
		}
	},
    "Resources" : {
    	"ActivitiesTable": {
    		"Type": "AWS::DynamoDB::Table",
    		"Properties": {
    			"TableName": {"Fn::Sub": "activity-log-activities-${Environment}-table"},
    			"KeySchema": [
    				{"AttributeName": "id", "KeyType": "HASH"}
    			],
				"AttributeDefinitions" : [
			        {
			            "AttributeName" : "id",
			            "AttributeType" : "S"   
			        }
			    ],
			    "ProvisionedThroughput": {
			    	"ReadCapacityUnits": 5,
			    	"WriteCapacityUnits": 5
			    },
    			"Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
    				{"Key": "sc:functionality:area", "Value": "Activities"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
    			]
    		}
    	},
    	"DutiesTable": {
    		"Type": "AWS::DynamoDB::Table",
    		"Properties": {
    			"TableName": {"Fn::Sub": "activity-log-duties-${Environment}-table"},
    			"KeySchema": [
    				{"AttributeName": "id", "KeyType": "HASH"}
    			],
				"AttributeDefinitions" : [
			        {
			            "AttributeName" : "id",
			            "AttributeType" : "S"   
			        }
			    ],
			    "ProvisionedThroughput": {
			    	"ReadCapacityUnits": 5,
			    	"WriteCapacityUnits": 5
			    },
			    "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
    			]
    		}
    	},
        "DutyTypesTable": {
            "Type": "AWS::DynamoDB::Table",
            "Properties": {
                "TableName": {"Fn::Sub": "activity-log-duty-types-${Environment}-table"},
                "KeySchema": [
                    {"AttributeName": "id", "KeyType": "HASH"}
                ],
                "AttributeDefinitions" : [
                    {
                        "AttributeName" : "id",
                        "AttributeType" : "S"   
                    }
                ],
                "ProvisionedThroughput": {
                    "ReadCapacityUnits": 5,
                    "WriteCapacityUnits": 5
                },
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "CreateDutyTypeFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Sub": "activity-log-create-duty-type-${Environment}-function"},
                "Code": {
                    "S3Bucket": "sebcel-activity-log-backend-sources",
                    "S3Key": "CreateDutyTypeFunction.zip"
                },
                "Environment": {
                    "Variables": {
                        "tableName": { "Ref": "DutyTypesTable"}
                    }
                },
                "Handler": "CreateDutyTypeFunction.handler",
                "Runtime": "nodejs8.10",
                "Timeout": 60,
                "MemorySize": 128,
                "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "GetDutyTypesFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Sub": "activity-log-get-duty-types-${Environment}-function"},
                "Code": {
                    "S3Bucket": "sebcel-activity-log-backend-sources",
                    "S3Key": "GetDutyTypesFunction.zip"
                },
                "Environment": {
                    "Variables": {
                        "tableName": { "Ref": "DutyTypesTable"}
                    }
                },
                "Handler": "GetDutyTypesFunction.handler",
                "Runtime": "nodejs8.10",
                "Timeout": 60,
                "MemorySize": 128,
                "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "GetDutiesFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Sub": "activity-log-get-duties-${Environment}-function"},
                "Code": {
                    "S3Bucket": "sebcel-activity-log-backend-sources",
                    "S3Key": "GetDutiesFunction.zip"
                },
                "Environment": {
                    "Variables": {
                        "tableName": { "Ref": "DutiesTable"}
                    }
                },
                "Handler": "GetDutiesFunction.handler",
                "Runtime": "nodejs8.10",
                "Timeout": 60,
                "MemorySize": 128,
                "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "SaveDutyDataFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Sub": "activity-log-save-duty-data-${Environment}-function"},
                "Code": {
                    "S3Bucket": "sebcel-activity-log-backend-sources",
                    "S3Key": "SaveDutyDataFunction.zip"
                },
                "Environment": {
                    "Variables": {
                        "dutiesTableName": { "Ref": "DutiesTable"},
                        "dutyTypesTableName": { "Ref": "DutyTypesTable"}
                    }
                },
                "Handler": "SaveDutyDataFunction.handler",
                "Runtime": "nodejs8.10",
                "Timeout": 60,
                "MemorySize": 128,
                "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "DeleteDutyDataFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {"Fn::Sub": "activity-log-delete-duty-data-${Environment}-function"},
                "Code": {
                    "S3Bucket": "sebcel-activity-log-backend-sources",
                    "S3Key": "DeleteDutyDataFunction.zip"
                },
                "Environment": {
                    "Variables": {
                        "tableName": { "Ref": "DutiesTable"}
                    }
                },
                "Handler": "DeleteDutyDataFunction.handler",
                "Runtime": "nodejs8.10",
                "Timeout": 60,
                "MemorySize": 128,
                "Role": { "Fn::GetAtt": ["LambdaExecutionRole", "Arn"]},
                "Tags": [
                    {"Key": "sc:application", "Value": "Activity Log"},
                    {"Key": "sc:functionality:area", "Value": "Duties"},
                    {"Key": "sc:environment", "Value": {"Fn::Sub": "${Environment}"}}
                ]
            }
        },
        "LambdaExecutionRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": ["lambda.amazonaws.com"]
                            },
                            "Action": ["sts:AssumeRole"]
                        }
                    ]
                },
                "Path": "/"
            }
        },
        "LambdaExecutionPolicy": {
            "DependsOn": [
                "LambdaExecutionRole"
            ],
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "sebcel-activity-log-access-dynamodb-tables",
                "Roles": [
                    {"Ref": "LambdaExecutionRole"}
                ],
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": ["logs:*"],
                            "Resource": ["arn:aws:logs:*:*:*"]
                        },
                        {
                            "Effect": "Allow",
                            "Action": [
                                "dynamodb:PutItem",
                                "dynamodb:GetItem",
                                "dynamodb:Scan",
                                "dynamodb:DeleteItem"
                            ],
                            "Resource": [
                                { "Fn::GetAtt": ["ActivitiesTable", "Arn"]},
                                { "Fn::GetAtt": ["DutiesTable", "Arn"]},
                                { "Fn::GetAtt": ["DutyTypesTable", "Arn"]}
                            ]
                        }
                    ]
                }
            }
        }
    }
}